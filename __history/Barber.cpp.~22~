//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop
#include "Client.h"
#include "Barber.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm1 *Form1;
//---------------------------------------------------------------------------
__fastcall TForm1::TForm1(TComponent* Owner)
	: TForm(Owner)
{
Form1->Add->Enabled = false; //кнопка добавления в очередь неактивная
Barber = CreateMutex(NULL, false, "barber"); // создаем мьютекс парикмахера
Form1->Sleep->Visible = false;
Form1->Work->Visible = false;
}
//---------------------------------------------------------------------------
void __fastcall TForm1::N2Click(TObject *Sender)
{
ShowMessage ("В парикмахерской имеются 5 кресел для посетителей в зале ожидания и 1 кресло в зале стрижки.\nЕсли посетитель может занять место в зале ожидания он его занимает,\nесли мест нет, он уходит.\nЕсли в парикмахерской долгое время нет клиентов парикмахер засыпает.");
}
//---------------------------------------------------------------------------

void __fastcall TForm1::N3Click(TObject *Sender)
{
Close();
}
//---------------------------------------------------------------------------

void __fastcall TForm1::N1Click(TObject *Sender)
{
Timer1->Interval = 15000; //задаем таймеру интервал проверки "занятости" парикмахера 15 секунд
Timer1->Enabled = true;
Form1->Events->Lines->Add("Парикмахерская открылась, парикмахер и ждет клиентов");
Form1->N1->Enabled = false; //кнопка начала работы недоступна
Form1->Add->Enabled = true; //кнопка добавления в очередь активная
Form1->Sleep->Visible = false; //картинка спящего парикмахера скрыта
Form1->Work->Visible = true;  //картинка ножниц появилась
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Timer1Timer(TObject *Sender) //таймер, который проверяет занятость парикмахера
{
if (sleep == true) { //если парикмахер не спит
//проверяем свободен ли парикмахер (нет ли клиентов)
DWORD barber_kr = WaitForSingleObject(Barber, 0); // если парикмахер свободен, то WaitForSingleObject вернет значение WAIT_OBJECT_0, если он занят посетителем то WAIT_TIMEOUT
//если клиентов нет (функция вернула WAIT_OBJECT_0), мы занимаем парикмахера - он парикмахер засыпает
if ((barber_kr == WAIT_OBJECT_0)) {
	Form1->Events->Lines->Add("Парикмахер уснул на своем рабочем месте"); //выводится надпись
	sleep = false; //переменную переводим в сосотояние false (парикмахер спит)
	Form1->Sleep->Visible = true; //в окне появляется картинка спящего парикмахера
	Form1->Work->Visible = false; //картинка ножниц скрывается
}
}
//запускаем таймер снова, для непрерывной проверки на наличие клиентов
Timer1->Enabled = false; //таймер выключается
Timer1->Enabled = true;	 //таймер снова включается
}
//---------------------------------------------------------------------------

void __fastcall TForm1::AddClick(TObject *Sender) //кнопа добавления клиента в очередь
{
if (sleep == false) { //если парикмахер спит, то создаем клиента и будим парикмахера
	STARTUPINFO si = { sizeof(si) }; //структура необходимая для создания процесса
	PROCESS_INFORMATION pi; //тоже структура для процесса
	//создаем клиента
	CreateProcess(NULL, "Client1.exe", NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi); //создаем новый процесс
	Form1->Events->Lines->Add("Клиент разбудил парикмахера"); //на экране появляется эта надпись
	Form1->Sleep->Visible = false; //картинка спящего парикмахера скрывается
        Form1->Work->Visible = true; //появляется картинка ножниц
	//будим парикмахера
	ReleaseMutex(Barber); //освобождаем парикмахера с помощью функции ReleaseMutex
	sleep = true; //парикмахер не спит
	} else { //если же парикмахер не спит, то просто создаем клиента
		STARTUPINFO si = { sizeof(si) };
		PROCESS_INFORMATION pi;
		CreateProcess(NULL, "Client1.exe", NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);
	}
}
//---------------------------------------------------------------------------

